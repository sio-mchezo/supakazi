<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="css/leaflet.css"
    crossorigin=""
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .header {
      background-color: #2c3e50;
      color: white;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
    }

    .map-container {
      position: relative;
      height: calc(100vh - 80px);
      width: 100%;
    }

    #map {
      display:block;
      height: 100%;
      height: 100vh;
      width: 100%;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .error {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #e74c3c;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      z-index: 1000;
      max-width: 300px;
    }

    .info-panel {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      max-width: 250px;
    }


    #count {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .pulsating-icon {
      background: transparent;
      width: 20px;
      height: 20px;
    }

    .pulse-circle {
      width: 20px;
      height: 20px;
      background: rgba(0, 123, 255, 0.6);
      border: 2px solid #007bff;
      border-radius: 50%;
      animation: pulse 1.5s infinite ease-in-out;
      box-shadow: 0 0 0 rgba(0, 123, 255, 0.4);
    }


    #redx {
      background: red;
    }


    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 0.9;
      }
      50% {
        transform: scale(1.5);
        opacity: 0.4;
      }
      100% {
        transform: scale(1);
        opacity: 0.9;
      }
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 20px;
      }

      .info-panel {
        position: relative;
        margin: 10px;
        max-width: none;
      }

      .map-container {
        height: calc(100vh - 120px);
      }
    }
  </style>
</head>
<body>


  <div class="map-container">
    <div id="loading" class="loading">
      <p>Loading data...</p>
    </div>

    <div id="error" class="error" style="display: none;">
      <p id="error-message"></p>
    </div>

    <div class="info-panel">
      <div>count: <span id="count"></span></div>
      <a href="#" onclick="getlatlong()">get lat/long</a>
      <div id="latlong"></div>
    </div>

    <div id="map"></div>
  </div>

  <!-- Leaflet JavaScript -->
  <script src="js/leaflet.js"
          crossorigin=""></script>

  <!-- PapaParse for CSV parsing -->
  <script src="js/papaparse.min.js"></script>
  
  <!-- media metadata info -->  
  <script type="text/javascript" src="https://unpkg.com/mediainfo.js"></script>

  <script>
    // const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/1eaWKPGi0BdU93PBPc-SNHrdVDxnhBBl2kZUZ1sa7OYo/export?format=csv';
    const GOOGLE_SHEETS_URL = 'http://localhost/map/data/data.csv';

    let map;
    let barricadeMarkers = [];

    function initMap() {
      map = L.map('map').setView([-1.286389, 36.817223], 13);

      // Define base layers
      const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      });

      const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community',
        maxZoom: 19
      });

      // Add default layer
      streetLayer.addTo(map);

      // Add layer control
      const baseLayers = {
        "Street Map": streetLayer,
        "Satellite": satelliteLayer
      };
      L.control.layers(baseLayers).addTo(map);

      loadBarricadesFromGoogleSheets();


      map.on('click', function(e) {
          document.getElementById('latlong').innerHTML = e.latlng.lat +' | '+ e.latlng.lng;
          // alert("Lat, Lon : " + e.latlng.lat + ", " + e.latlng.lng)
      });

      // setInterval(loadBarricadesFromGoogleSheets, 2 * 60 * 1000);
    }

    async function loadBarricadesFromGoogleSheets() {
      try {
        showLoading(true);
        hideError();

        const response = await fetch(GOOGLE_SHEETS_URL);
        const csvText = await response.text();
        // console.log(csvText)

        Papa.parse(csvText, {
          header: true,
          complete: function(results) {
            const datapoint = results.data.filter(row =>
              row.latitude && row.longitude && row.name
            );

            clearMarkers();
            datapoint.forEach(xpoint => {
              addBarricadeMarker(xpoint);
            });
            updateBarricadeCount(datapoint.length);
            showLoading(false);
          },
          error: function(error) {
            console.error('Error parsing CSV:', error);
            showError('Error parsing data');
            showLoading(false);
          }
        });
      } catch (error) {
        console.error('Error fetching from Google Sheets:', error);
        showError('Failed to fetch data from Google Sheets');
        showLoading(false);
      }
    }

    function addBarricadeMarker(xpoint) {
      const lat = parseFloat(xpoint.latitude);
      const lng = parseFloat(xpoint.longitude);

      if (isNaN(lat) || isNaN(lng)) {
        console.warn('Invalid coordinates for xpoint:', xpoint);
        return;
      }

      const customIcon = L.divIcon({
        className: 'pulsating-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10],
        popupAnchor: [0, -10],
        html: '<div class="pulse-circle"></div>'
      });

      const marker = L.marker([lat, lng], { icon: customIcon });
      
      if (xpoint.severity == 'high') {
        console.log('xx')
      }
      
      // specify popup options 
      const customOptions = {
          'maxWidth': 400,
          'width': 200,
          'className' : 'redx',
          'id' : 'redx'
      }

      const popupContent = `
        <div style="min-width: 200px;">
          <h3 style="margin: 0 0 10px 0; color: #2c3e50;">${xpoint.name}</h3>
          <p><strong>Description:</strong> ${xpoint.description}</p>
          <p><strong>Severity:</strong> ${xpoint.severity}</p>
          <p><strong>Date:</strong> ${xpoint.date}</p>
          <p><strong>Time:</strong> ${xpoint.time}</p>
        </div>
      `;

      marker.bindPopup(popupContent);
      // marker.bindPopup(popupContent, customOptions);
      marker.addTo(map);
      barricadeMarkers.push(marker);
    }

    function clearMarkers() {
      barricadeMarkers.forEach(marker => {
        map.removeLayer(marker);
      });
      barricadeMarkers = [];
    }

    function updateBarricadeCount(count) {
      document.getElementById('count').textContent = count;
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('error').style.display = 'block';
      setTimeout(hideError, 5000);
    }

    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', initMap);

function getlatlong() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;
      // console.log(`Latitude: ${latitude}, Longitude: ${longitude}`);
      document.getElementById('latlong').innerHTML = `Latitude: ${latitude}, Longitude: ${longitude}`;
    });
  } else {
    console.log("Geolocation is not supported by this browser.");
  }  
}

  </script>
</body>
</html>
